name: EPG

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (for parsing JSON)
        run: sudo apt-get install -y jq

      - name: Download files from files.json
        env:
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          
          cat files.json | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r filename url; do
            echo "Downloading $filename from $url"
            xml_file="./$filename"
            xml_file_tmp="$xml_file.tmp"
            if [[ "$url" == "https://assets.livednow.com/epg.xml" ]]; then
              curl --retry 5 -x "$PROXY_URL" -o "$xml_file_tmp" "$url"
            else
              curl --retry 5 -o "$xml_file_tmp" "$url"
            fi
            if [ ! -f "$xml_file" ] || ! cmp -s "$xml_file_tmp" "$xml_file"; then
              mv "$xml_file_tmp" "$xml_file"
              
            else
              rm "$xml_file_tmp"
            fi
          
          
